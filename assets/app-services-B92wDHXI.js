import{i as t,g as e,a,b as r,c as s,q as o,w as i,d as c,e as d,f as n,s as h,h as u,j as g,k as w,u as m,l as y}from"./vendor-firebase-BBMrpKQ9.js";import{s as f}from"./app-utils-CDJKhibu.js";const l=t({apiKey:"AIzaSyD4HbsUM4VnVfccf81cDQzg3fSN4zL2qY0",authDomain:"todoapp-5140d.firebaseapp.com",projectId:"todoapp-5140d",storageBucket:"todoapp-5140d.firebasestorage.app",messagingSenderId:"867891118649",appId:"1:867891118649:web:21bd8747ae62d9374d43e8",measurementId:"G-XT8S3PLZ38"});"undefined"!=typeof window&&e(l);const p=a(l),I=r(l),C="categories",U={async getUserCategories(t){try{const e=s(p,C),a=o(e,i("userId","==",t)),r=await c(a),d=[],n={};return r.forEach((t=>{const e=t.data();d.push(e.name),void 0!==e.order?n[e.name]=e.order:n[e.name]=999})),0===d.length?f.getCustomCategories():(f.set("categoriesOrder",n),d)}catch(e){throw e}},async addCustomCategory(t,e){try{const a=f.getCategoriesOrder(),r=Object.values(a).reduce(((t,e)=>Math.max(t,e)),0)+1,s=n(p,C,`${t}_${e}`);await h(s,{userId:t,name:e,order:r,createdAt:u()});const o=f.getCustomCategories();return o.includes(e)||(f.set("customCategories",[...o,e]),f.setCategoryOrder(e,r)),await this.getUserCategories(t)}catch(a){throw a}},async updateCategoryOrder(t,e,a){try{const r=n(p,C,`${t}_${e}`);return await h(r,{order:a},{merge:!0}),f.setCategoryOrder(e,a),await this.getUserCategories(t)}catch(r){throw r}},async removeCustomCategory(t,e){try{const a=n(p,C,`${t}_${e}`);await d(a);const r=f.getCustomCategories();f.set("customCategories",r.filter((t=>t!==e)));const s=f.getCategoriesOrder();return delete s[e],f.set("categoriesOrder",s),await this.getUserCategories(t)}catch(a){throw a}},async saveCategories(t,e){try{const a=s(p,C),r=o(a,i("userId","==",t)),g=await c(r),w=[];g.forEach((t=>{w.push(d(n(p,C,t.id)))})),w.length>0&&await Promise.all(w);const m=f.getCategoriesOrder()||{},y=e.map(((e,a)=>{const r=void 0!==m[e]?m[e]:1e3+a;return h(n(p,C,`${t}_${e}`),{userId:t,name:e,order:r,createdAt:u()})}));return await Promise.all(y),f.set("customCategories",e),e}catch(a){throw a}},getCategoryOrderMap:()=>({personal_care:10,meal:20,work:30,household_chores:40,transportation:50,physical_activity:60,social_interaction:70,...f.getCategoriesOrder()}),sortCategoriesByOrder(t){const e=this.getCategoryOrderMap();return[...t].sort(((t,a)=>(void 0!==e[t]?e[t]:999)-(void 0!==e[a]?e[a]:999)))}},b="sharing",A="users",k={async shareCategory(t,e,a){try{const r=o(s(p,A),i("email","==",a)),d=await c(r);if(d.empty)throw new Error("User not found");const h=d.docs[0].id;if(h===e)throw new Error("Cannot share with yourself");const m={categoryName:t,ownerUid:e,targetUid:h,targetEmail:a,createdAt:u(),updatedAt:u()},y=await g(s(p,b),m),f=o(s(p,"tasks"),i("userId","==",e),i("category","==",t)),l=await c(f),I=w(p);return l.forEach((t=>{const e=n(p,"tasks",t.id),a=t.data().sharedWith||[];a.includes(h)||I.update(e,{sharedWith:[...a,h]})})),await I.commit(),{id:y.id,...m}}catch(r){throw r}},async getSharedWithMe(t){try{const e=o(s(p,b),i("targetUid","==",t)),a=await c(e),r=[];return a.forEach((t=>{r.push({id:t.id,...t.data()})})),r}catch(e){throw e}},async getMyShares(t){try{const e=o(s(p,b),i("ownerUid","==",t)),a=await c(e),r=[];return a.forEach((t=>{r.push({id:t.id,...t.data()})})),r}catch(e){throw e}},async removeShare(t){try{return await d(n(p,b,t)),t}catch(e){throw e}},async getUserByEmail(t){try{const e=o(s(p,A),i("email","==",t)),a=await c(e);return a.empty?null:{uid:a.docs[0].id,...a.docs[0].data()}}catch(e){throw e}}},E="tasks",O={async getUserTasks(t){try{const e=o(s(p,E),i("userId","==",t)),a=await c(e),r=[];a.forEach((t=>{r.push({...t.data(),id:t.id,firebaseId:t.id})}));const d=await k.getSharedWithMe(t);for(const t of d){const e=o(s(p,E),i("userId","==",t.ownerUid),i("category","==",t.categoryName));(await c(e)).forEach((e=>{const a=e.data();r.push({...a,id:e.id,firebaseId:e.id,sharedBy:t.ownerUid,sharedByEmail:t.targetEmail,isShared:!0})}))}return r}catch(e){throw e}},async addTask(t,e){try{const a={...t,userId:e,createdAt:u(),updatedAt:u()},r=await g(s(p,E),a);return{...t,id:r.id,firebaseId:r.id}}catch(a){throw a}},async updateTask(t,e){try{const{firebaseId:a}=t;if(!a)throw new Error("Firebase ID missing");const r=n(p,E,a);return await m(r,{...t,userId:e,updatedAt:u()}),t}catch(a){throw a}},async deleteTask(t){try{return await d(n(p,E,t)),t}catch(e){throw e}},async syncTasks(t){try{const e=f.get("tasks",[]);if(0===e.length)return await this.getUserTasks(t);const a=await this.getUserTasks(t),r=w(p),o=e.filter((t=>!t.firebaseId&&!a.some((e=>e.id===t.id))&&!t.isShared));for(const c of o){const e={...c,userId:t,createdAt:u(),updatedAt:u()},a=n(s(p,E));r.set(a,e),c.firebaseId=a.id}await r.commit();const i=[...a];for(const t of e)if(t.firebaseId&&!t.isShared){const e=i.findIndex((e=>e.firebaseId===t.firebaseId));e>=0&&(i[e]=t)}else t.isShared||i.push(t);return i}catch(e){throw e}},async syncTaskList(t,e){try{const a=w(p);for(const r of t)if(r.firebaseId){const t=n(p,E,r.firebaseId);a.update(t,{...r,userId:e,updatedAt:u()})}else{const t={...r,userId:e,createdAt:u(),updatedAt:u()},o=n(s(p,E));a.set(o,t),r.firebaseId=o.id}return await a.commit(),t}catch(a){throw a}}},S="users",v={async getUserPreferences(t){try{const e=n(p,S,t),a=await y(e);return a.exists()?a.data():{theme:f.get("theme","lightWash"),language:f.get("language","pt")}}catch(e){throw e}},async saveUserPreferences(t,e){try{const a=n(p,S,t),s=r().currentUser;let o=null;s&&s.email&&(o=s.email);const i={...e,updatedAt:u()};return o&&(i.email=o),await h(a,i,{merge:!0}),e}catch(a){throw a}},async updatePreference(t,e,a){try{const s=n(p,S,t),o=await y(s),i={[e]:a,updatedAt:u()};if(!o.exists()||!o.data().email){const t=r().currentUser;t&&t.email&&(i.email=t.email)}return await h(s,i,{merge:!0}),{[e]:a}}catch(s){throw s}},async ensureUserEmail(t){try{const e=n(p,S,t),a=await y(e);if(a.exists()&&a.data().email)return a.data().email;const s=r().currentUser;return s&&s.email?(await h(e,{email:s.email,updatedAt:u()},{merge:!0}),s.email):null}catch(e){throw e}}};export{I as a,U as c,k as s,O as t,v as u};
